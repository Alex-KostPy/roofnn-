# RoofNN — Путеводитель по крышам Нижнего Новгорода

Telegram-бот с Mini App: карта точек (крыши/пролазы), туториалы в Telegraph, аккаунты с балансом, модерация новых точек админом.

## Что это

- **Бот** (aiogram 3): приветствие, кнопка «Открыть карту», уведомления админу о новых точках с кнопками «Одобрить (+40 руб)» / «Отклонить», пополнение баланса пользователям (`/add_balance`).
- **API** (FastAPI): список точек, покупка доступа к тутору (20 ₽ или 1 бесплатная попытка), добавление точки, профиль пользователя, админ-эндпоинты (одобрить/отклонить, начислить баланс).
- **Mini App** (веб): карта Leaflet, вкладки «Карта», «Список», «Добавить», «Профиль»; в точке показывается автор тутора; свои туторы открываются бесплатно.

## Структура проекта

| Файл / папка | Назначение |
|--------------|------------|
| `main.py` | Бот: `/start`, кнопка Web App, обработка «Одобрить»/«Отклонить» через API, `/add_balance` для админа. |
| `database.py` | SQLAlchemy + SQLite: таблицы `Users` (tg_id, balance, free_attempts, username, first_name), `Spots` (title, lat, lon, telegraph_url, author_id, author_username, is_active). |
| `models.py` | Pydantic-схемы для API. |
| `web/server.py` | FastAPI: `/api/spots`, `/api/me`, `/api/buy_spot`, `/api/add_spot`, `/api/admin/approve_spot`, `/api/admin/reject_spot`, `/api/admin/add_balance`. |
| `web/index.html` | Mini App: шапка, навигация (Карта / Список / Добавить / Профиль), карта, список точек, форма добавления, профиль. |
| `web/style.css` | Стили приложения. |
| `web/script.js` | Логика: загрузка точек и профиля, карта, список, открытие тутора (свои — бесплатно), добавление точки. |

## Переменные окружения

Создайте файл `.env` в корне (по образцу ниже). В репозиторий не попадает (см. `.gitignore`).

```env
BOT_TOKEN=токен_от_BotFather
ADMIN_ID=ваш_Telegram_user_id
WEBAPP_URL=https://ваш-фронт.netlify.app
ROOFNN_API_URL=https://ваш-api.onrender.com
```

- **BOT_TOKEN** — токен бота от [@BotFather](https://t.me/BotFather).
- **ADMIN_ID** — ваш Telegram user ID (например, от [@userinfobot](https://t.me/userinfobot)); только этот пользователь получает уведомления о новых точках и может одобрять/отклонять и пополнять баланс.
- **WEBAPP_URL** — URL Mini App (фронт), например Netlify. Должен быть **HTTPS**.
- **ROOFNN_API_URL** — URL бэкенда (например Render). Нужен боту для вызова админ-эндпоинтов; по умолчанию `https://roofnn.onrender.com`.

## Установка и запуск

### Локально

```bash
python -m venv venv
venv\Scripts\activate   # Windows
pip install -r requirements.txt
```

- **Бот:**  
  `python main.py`

- **API (для разработки):**  
  `uvicorn web.server:app --host 0.0.0.0 --port 8000`

В `web/index.html` задайте `window.ROOFNN_API_BASE` на ваш API (при локальном фронте — `http://localhost:8000` или URL Render).

### Деплой

- **API:** Render → New Web Service → репозиторий GitHub. Build: `pip install -r requirements.txt`, Start: `uvicorn web.server:app --host 0.0.0.0 --port $PORT`. В Environment задать `BOT_TOKEN`, `ADMIN_ID`.
- **Фронт:** Netlify (или другой хост) — залить содержимое папки `web/` или собрать из репо; в `index.html` указать `ROOFNN_API_BASE` на URL API (например `https://roofnn.onrender.com`).
- **Бот:** запускать у себя (или на сервере) с заполненным `.env`; в BotFather для бота указать Menu Button → Web App → URL = `WEBAPP_URL`.

## Как пользоваться

1. Пользователь открывает бота, нажимает «Открыть карту» — открывается Mini App.
2. **Карта** — маркеры активных точек; клик по маркеру → карточка с названием, автором тутора и кнопкой «Открыть туториал». Свои точки открываются бесплатно; чужие — 20 ₽ с баланса или 1 бесплатная попытка (у новых пользователей 2 попытки).
3. **Список** — все точки списком с автором; свои помечены «Ваш».
4. **Добавить** — форма: название, ссылка на тутор в Telegraph, координаты (выбор на карте). После отправки точка уходит на модерацию; админ в боте получает сообщение с кнопками «Одобрить (+40 руб)» / «Отклонить». После одобрения автору начисляется 40 ₽.
5. **Профиль** — баланс (₽), бесплатные попытки, подсказка по пополнению (написать админу).
6. **Пополнение баланса:** админ в боте отправляет команду  
   `/add_balance <tg_id> <сумма>`  
   например: ` /add_balance 123456789 500` — начислить 500 ₽ пользователю с указанным Telegram ID.

## Язык и лицензия

Тексты интерфейса и комментарии в коде — на русском. Код можно использовать и дорабатывать по своему усмотрению.
